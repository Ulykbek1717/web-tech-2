<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ShopLite â€” Manage Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/css/style.css" rel="stylesheet">
  
  <script>
    (function() {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="../index.html">ShopLite</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarsMain">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="../products.html">Products</a></li>
          <li class="nav-item cart-item"><a class="nav-link" href="../cart.html">Cart <span class="badge bg-primary" id="cart-count">0</span></a></li>
          <li class="nav-item" id="navAuth">
            <a class="nav-link" href="../login.html">Login</a>
          </li>
          <li class="nav-item"><button id="mode-toggle" class="btn btn-sm btn-outline-light ms-2">ðŸŒ™</button></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="mt-5 pt-4">
    <div class="container">
      <h3 class="mb-4">Manage Orders</h3>

      <div id="alertContainer"></div>

      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr>
              <td colspan="7" class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/app.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script>
    // Check authorization
    if (!Auth.isLoggedIn()) {
      window.location.href = '../login.html';
    } else {
      const user = Auth.getUser();
      if (user.role !== 'admin' && user.role !== 'superadmin') {
        alert('Access denied. Admin privileges required.');
        window.location.href = '../index.html';
      }
    }

    const statusColors = {
      'pending': 'warning',
      'processing': 'info',
      'paid': 'success',
      'shipped': 'primary',
      'delivered': 'success',
      'cancelled': 'danger'
    };

    // Load orders
    async function loadOrders() {
      try {
        const response = await Auth.request('/api/orders');
        const result = await response.json();
        
        if (!result.success) throw new Error('Failed to load orders');
        
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        
        if (result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center">No orders found</td></tr>';
          return;
        }
        
        result.data.forEach(order => {
          const date = new Date(order.createdAt).toLocaleDateString();
          const customerName = order.userId?.name || order.userId?.email || 'Unknown';
          
          const row = `
            <tr>
              <td><small>${order._id.substring(0, 8)}...</small></td>
              <td>${customerName}</td>
              <td>${order.items.length} items</td>
              <td>â‚¸ ${order.totalAmount.toLocaleString()}</td>
              <td>
                <select class="form-select form-select-sm status-select" data-order-id="${order._id}" style="width:auto;">
                  <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                  <option value="paid" ${order.status === 'paid' ? 'selected' : ''}>Paid</option>
                  <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                  <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                  <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
              </td>
              <td>${date}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="viewOrder('${order._id}')">View</button>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
        
        // Add status change listeners
        document.querySelectorAll('.status-select').forEach(select => {
          select.addEventListener('change', async (e) => {
            const orderId = e.target.dataset.orderId;
            const newStatus = e.target.value;
            await updateOrderStatus(orderId, newStatus);
          });
        });
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading orders</td></tr>';
      }
    }

    // Update order status
    async function updateOrderStatus(orderId, status) {
      try {
        const response = await Auth.request(`/api/orders/${orderId}/status`, {
          method: 'PUT',
          body: JSON.stringify({ status })
        });
        
        if (!response.ok) throw new Error('Failed to update status');
        
        showAlert('Order status updated successfully!', 'success');
      } catch (error) {
        showAlert(error.message, 'danger');
        loadOrders(); // Reload to reset status
      }
    }

    // View order details
    async function viewOrder(orderId) {
      try {
        const response = await Auth.request(`/api/orders/${orderId}`);
        const result = await response.json();
        
        if (!result.success) throw new Error('Failed to load order');
        
        const order = result.data;
        const items = order.items.map(item => 
          `<li>${item.name} - ${item.quantity} x â‚¸${item.price.toLocaleString()}</li>`
        ).join('');
        
        const details = `
          <strong>Order ID:</strong> ${order._id}<br>
          <strong>Customer:</strong> ${order.userId?.name || order.userId?.email}<br>
          <strong>Status:</strong> ${order.status}<br>
          <strong>Total:</strong> â‚¸${order.totalAmount.toLocaleString()}<br>
          <strong>Date:</strong> ${new Date(order.createdAt).toLocaleString()}<br><br>
          <strong>Shipping Address:</strong><br>
          ${order.shippingAddress.fullName}<br>
          ${order.shippingAddress.address}<br>
          ${order.shippingAddress.city}, ${order.shippingAddress.postalCode}<br>
          ${order.shippingAddress.country}<br>
          Phone: ${order.shippingAddress.phone}<br><br>
          <strong>Items:</strong><ul>${items}</ul>
        `;
        
        showAlert(details, 'info');
      } catch (error) {
        showAlert(error.message, 'danger');
      }
    }

    function showAlert(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      alertContainer.appendChild(alert);
      
      setTimeout(() => alert.remove(), 10000);
    }

    // Load orders on page load
    loadOrders();
  </script>
</body>
</html>
